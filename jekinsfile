pipeline {
    agent any

    environment {
        VENV_DIR = 'venv'
        SAFETY_API_KEY = 'd1e5e2d2-b35c-4fc0-a9bd-0085ef272b56'  // API key in env
    }

    stages {
        stage('Clone Repository') {
            steps {
                git branch: 'main', url: 'https://github.com/OT-MICROSERVICES/attendance-api.git'
            }
        }

        stage('Install System Dependencies') {
            steps {
                sh '''
                sudo apt-get update -y
                sudo apt-get install -y python3 python3-pip python3-venv libpq-dev python3-dev
                '''
            }
        }

        stage('Set Up Virtual Environment') {
            steps {
                sh '''
                python3 -m venv ${VENV_DIR}
                . ${VENV_DIR}/bin/activate && python3 -m pip install --upgrade pip
                '''
            }
        }

        stage('Install Project Dependencies') {
            steps {
                sh '''
                . ${VENV_DIR}/bin/activate && \
                if [ -f requirements.txt ]; then
                    pip install -r requirements.txt
                else
                    pip install pipreqs && pipreqs . --force && pip install -r requirements.txt
                fi
                '''
            }
        }

        stage('Install Safety Tool') {
            steps {
                sh '''
                . ${VENV_DIR}/bin/activate && \
                pip install --upgrade safety
                '''
            }
        }

        stage('Check Safety Version') {
            steps {
                sh '''
                . ${VENV_DIR}/bin/activate && \
                safety --version
                '''
            }
        }

        stage('Run Safety Scan') {
            steps {
                sh '''
                . ${VENV_DIR}/bin/activate && \
                SAFETY_API_KEY=${SAFETY_API_KEY} safety check --full-report
                '''
                // OR if you want JSON output, use below (comment the above):
                // SAFETY_API_KEY=${SAFETY_API_KEY} safety check --json
            }
        }
    }
}
